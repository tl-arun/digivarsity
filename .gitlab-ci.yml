# GitLab CI/CD Pipeline Configuration

stages:
  - test
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  MYSQL_DATABASE: testing
  MYSQL_ROOT_PASSWORD: password
  DB_HOST: mysql
  DB_USERNAME: root
  REDIS_HOST: redis

# Test Stage
test:
  stage: test
  image: php:8.2-cli
  
  services:
    - mysql:8.0
    - redis:7-alpine
  
  before_script:
    # Install system dependencies
    - apt-get update && apt-get install -y git curl libpng-dev libonig-dev libxml2-dev zip unzip nodejs npm
    
    # Install PHP extensions
    - docker-php-ext-install pdo_mysql mbstring exif pcntl bcmath gd
    
    # Install Composer
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    
    # Copy environment file
    - cp .env.example .env || echo "APP_KEY=" > .env
    - echo "DB_CONNECTION=mysql" >> .env
    - echo "DB_HOST=mysql" >> .env
    - echo "DB_PORT=3306" >> .env
    - echo "DB_DATABASE=$MYSQL_DATABASE" >> .env
    - echo "DB_USERNAME=$DB_USERNAME" >> .env
    - echo "DB_PASSWORD=$MYSQL_ROOT_PASSWORD" >> .env
    - echo "CACHE_DRIVER=redis" >> .env
    - echo "REDIS_HOST=$REDIS_HOST" >> .env
  
  script:
    # Install dependencies
    - composer install --no-interaction --prefer-dist --optimize-autoloader
    - npm ci
    
    # Generate app key
    - php artisan key:generate
    
    # Build assets
    - npm run build
    
    # Run migrations
    - php artisan migrate --force
    
    # Run tests
    - php artisan test
  
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - vendor/
      - node_modules/

# Build Docker Image
build:
  stage: build
  image: docker:24
  
  services:
    - docker:24-dind
  
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA $CI_REGISTRY_IMAGE:latest
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
  
  only:
    - main
    - develop

# Deploy to Production
deploy_production:
  stage: deploy
  image: alpine:latest
  
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $DEPLOY_HOST >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  
  script:
    - |
      ssh $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
        cd /var/www/digivarisity
        docker-compose pull
        docker-compose up -d
        docker-compose exec -T app php artisan migrate --force
        docker-compose exec -T app php artisan config:cache
        docker-compose exec -T app php artisan route:cache
        docker-compose exec -T app php artisan view:cache
        docker-compose exec -T app php artisan optimize
      EOF
  
  only:
    - main
  
  when: manual
  environment:
    name: production
    url: https://your-domain.com

# Deploy to Staging
deploy_staging:
  stage: deploy
  image: alpine:latest
  
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $STAGING_HOST >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  
  script:
    - |
      ssh $STAGING_USER@$STAGING_HOST << 'EOF'
        cd /var/www/digivarisity-staging
        docker-compose pull
        docker-compose up -d
        docker-compose exec -T app php artisan migrate --force
        docker-compose exec -T app php artisan config:cache
        docker-compose exec -T app php artisan optimize
      EOF
  
  only:
    - develop
  
  environment:
    name: staging
    url: https://staging.your-domain.com

